name: PR Checker and Slack Notifier

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options: [dev, pre-release, prod]

      run_backup_db:
        description: 'Backup database?'
        required: false
        type: boolean
        default: false

      run_restore_db:
        description: 'Restore database?'
        required: false
        type: boolean
        default: false

      application_name:
        description: 'Select Application'
        required: true
        type: choice
        options:
          -
          - powerbi
          - tableau
  schedule:
    - cron: '*/5 * * * *' # Database: Backup, Test (Pre-release)
    - cron: '*/6 * * * *'

jobs:
  set-environment:
    runs-on: ubuntu-latest
    outputs:
      ENV_NAME: ${{ steps.setenv.outputs.ENV_NAME }}
    steps:
      - id: setenv
        env:
          DISPATCH_ENV: ${{ github.event.inputs.environment || '' }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_BASE_REF_NAME: ${{ github.base_ref }}
          GITHUB_EVENT_SCHEDULE: ${{ github.event.schedule || '' }}
        run: |
          echo "Determining environment and image name..."
          if [[ "$GITHUB_EVENT_NAME" == "schedule" ]]; then
            if [[ "$GITHUB_EVENT_SCHEDULE" == "*/9 * * * *" ]]; then
              ENV_NAME="prod"
            elif [[ "$GITHUB_EVENT_SCHEDULE" == "*/5 * * * *" ]]; then
              ENV_NAME="pre-release"
            fi
          elif [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            ENV_NAME="$DISPATCH_ENV"
          elif [[ "$GITHUB_BASE_REF_NAME" == "pre-release" || "$GITHUB_REF_NAME" == "pre-release" ]]; then
            ENV_NAME="pre-release"
          elif [[ "$GITHUB_REF" == refs/tags/* || "$GITHUB_BASE_REF_NAME" == "master" || "$GITHUB_REF_NAME" == "master" ]]; then
            ENV_NAME="prod"
          else
            ENV_NAME="pre-release"
          fi
          echo "ENV_NAME=$ENV_NAME"
          echo "ENV_NAME=$ENV_NAME" >> "$GITHUB_OUTPUT"

  backup-db:
    runs-on: ubuntu-latest
    needs: set-environment
    if: |
      (github.event_name == 'schedule' && contains(fromJSON('["*/5 * * * *","*/9 * * * *"]'), github.event.schedule)) ||
      (github.event_name == 'workflow_dispatch' && contains(fromJSON('["dev", "pre-release", "prod"]'), inputs.environment) &&
        inputs.run_backup_db && contains(fromJSON('["powerbi", "tableau"]'), inputs.application_name))
    strategy:
      matrix:
        APP_NAME: ${{ fromJSON((github.event_name == 'schedule' && '["powerbi","tableau"]') || format('["{0}"]', inputs.application_name)) }}
    steps:
      - name: ${{ matrix.APP_NAME }}-${{ needs.set-environment.outputs.ENV_NAME }}
        env:
          APP_NAME: ${{ inputs.application_name }}
          SCHEDULE: $GITHUB_EVENT_SCHEDULE
          ENV_NAME: ${{ needs.set-environment.outputs.ENV_NAME }}
        id: check_prs
        run: |
          echo "APP_NAME: ${{ matrix.APP_NAME }}"
          echo "App: $APP_NAME"
          echo "ENV: $ENV_NAME"
          echo "Schedule: ${SCHEDULE:-<none>}"
  
      - name: Send PR URLs to Slack
        id: send_to_slack
        run: |
           echo $environment=${{ needs.set-environment.outputs.ENV_NAME }}

  a:
    runs-on: ubuntu-latest
    needs: backup-db
    steps:
      - run: echo "Deploy A to ${{ inputs.environment }}"
  
  b:
    runs-on: ubuntu-latest
    if: ${{ contains(fromJSON('["dev","pre-release"]'), inputs.environment) }}
    steps:
      - run: echo "Deploy B to ${{ inputs.environment }}"
  
  db_dump:
    runs-on: ubuntu-latest
    if: ${{ contains(fromJSON('["dev","pre-release"]'), inputs.environment) && inputs.run_db_dump }}
    steps:
      - run: echo "DB dump for ${{ inputs.environment }}"

  certbot:
    runs-on: ubuntu-latest
    if: ${{ contains(fromJSON('["dev","pre-release"]'), inputs.environment) && inputs.run_certbot }}
    steps:
      - run: echo "Certbot for ${{ inputs.environment }}"
